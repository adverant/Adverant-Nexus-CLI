name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          npm ci
          echo "Dependencies installed successfully"

      - name: Build packages
        run: |
          echo "Building packages..."
          npm run build
          echo "Build completed successfully"

      - name: Run tests
        run: npm test
        continue-on-error: true

      - name: List built packages
        run: |
          echo "Types dist:"
          ls -la packages/types/dist/ || echo "types not built"
          echo "SDK dist:"
          ls -la packages/sdk/dist/ || echo "sdk not built"
          echo "CLI dist:"
          ls -la packages/cli/dist/ || echo "cli not built"

      - name: Package CLI for distribution
        run: |
          # Create distribution package
          mkdir -p dist-package
          cp -r packages/cli/dist dist-package/
          cp packages/cli/package.json dist-package/
          cp README.md LICENSE dist-package/

          # Create install script
          cat > dist-package/install.sh << 'INSTALL_EOF'
          #!/bin/bash
          echo "Installing Nexus CLI..."
          npm install --production
          npm link
          echo "‚úì Nexus CLI installed successfully!"
          echo "Run 'nexus --help' to get started"
          INSTALL_EOF
          chmod +x dist-package/install.sh

          # Create archive
          tar -czf nexus-cli-${{ github.ref_name }}.tar.gz dist-package/

          # Create checksums
          sha256sum nexus-cli-${{ github.ref_name }}.tar.gz > nexus-cli-${{ github.ref_name }}.tar.gz.sha256

      - name: Debug npm environment
        run: |
          echo "=== Debugging npm authentication ==="
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo ""
          echo "=== Checking environment variables ==="
          echo "NPM_TOKEN set: $(if [ -n '${{ secrets.NPM_TOKEN }}' ]; then echo 'YES'; else echo 'NO'; fi)"
          echo "NPM_TOKEN length: ${#NPM_TOKEN_VALUE}"
          echo ""
          echo "=== Current .npmrc files ==="
          echo "~/.npmrc:"
          cat ~/.npmrc 2>/dev/null | sed 's/=.*/=***REDACTED***/' || echo "(not found)"
          echo ""
          echo ".npmrc in current dir:"
          cat .npmrc 2>/dev/null | sed 's/=.*/=***REDACTED***/' || echo "(not found)"
          echo ""
          echo "=== npm config list ==="
          npm config list
        env:
          NPM_TOKEN_VALUE: ${{ secrets.NPM_TOKEN }}

      - name: Configure npm authentication
        run: |
          echo "Configuring npm authentication..."
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "‚úì Created ~/.npmrc"
          cat ~/.npmrc | sed 's/=.*/=***REDACTED***/'
          echo ""
          echo "Testing authentication (may fail if token is automation type)..."
          npm whoami || echo "npm whoami failed - this is OK for automation tokens"

      - name: Publish @adverant-nexus/types to NPM
        working-directory: packages/types
        run: |
          echo "Publishing @adverant-nexus/types..."
          npm publish --access public 2>&1 || { echo "PUBLISH FAILED - see error above"; exit 1; }

      - name: Publish @adverant-nexus/sdk to NPM
        working-directory: packages/sdk
        run: |
          echo "Publishing @adverant-nexus/sdk..."
          npm publish --access public 2>&1 || { echo "PUBLISH FAILED - see error above"; exit 1; }

      - name: Publish @adverant-nexus/cli to NPM
        working-directory: packages/cli
        run: |
          echo "Publishing @adverant-nexus/cli..."
          npm publish --access public 2>&1 || { echo "PUBLISH FAILED - see error above"; exit 1; }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Nexus CLI ${{ github.ref_name }}
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## Nexus CLI ${{ github.ref_name }}

            ### üì¶ Quick Installation

            **Download & Install (Recommended)**
            ```bash
            # Download release archive
            curl -L https://github.com/adverant/Adverant-Nexus-CLI/releases/download/${{ github.ref_name }}/nexus-cli-${{ github.ref_name }}.tar.gz -o nexus-cli.tar.gz

            # Extract
            tar -xzf nexus-cli.tar.gz
            cd dist-package

            # Install (requires Node.js 20+)
            ./install.sh

            # Verify installation
            nexus --version
            ```

            **From NPM**
            ```bash
            npm install -g @adverant-nexus/cli
            ```

            **From Source**
            ```bash
            git clone https://github.com/adverant/Adverant-Nexus-CLI.git
            cd Adverant-Nexus-CLI
            npm install && npm run build
            cd packages/cli && npm link
            ```

            ### ‚ú® Features

            - ‚úÖ 60+ commands for Nexus service management
            - ‚úÖ Interactive REPL mode with tab completion
            - ‚úÖ Auto-discovery of services and MCP tools
            - ‚úÖ Session management and checkpointing
            - ‚úÖ Full TypeScript support (zero errors)
            - ‚úÖ Beautiful ASCII art banners
            - ‚úÖ Streaming output for real-time updates

            ### üöÄ Quick Start

            ```bash
            # View help
            nexus --help

            # List available services
            nexus services list

            # Check service health
            nexus services health --all

            # Start interactive shell
            nexus repl

            # View authentication options
            nexus auth --help
            ```

            ### üìù Changelog

            See full changes below (auto-generated).
          files: |
            nexus-cli-${{ github.ref_name }}.tar.gz
            nexus-cli-${{ github.ref_name }}.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
