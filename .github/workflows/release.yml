name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Run tests
        run: npm test
        continue-on-error: true

      - name: List built packages
        run: |
          echo "Types dist:"
          ls -la packages/types/dist/ || echo "types not built"
          echo "SDK dist:"
          ls -la packages/sdk/dist/ || echo "sdk not built"
          echo "CLI dist:"
          ls -la packages/cli/dist/ || echo "cli not built"

      - name: Package CLI for distribution
        run: |
          # Create distribution package
          mkdir -p dist-package
          cp -r packages/cli/dist dist-package/
          cp packages/cli/package.json dist-package/
          cp README.md LICENSE dist-package/

          # Create install script
          cat > dist-package/install.sh << 'INSTALL_EOF'
          #!/bin/bash
          echo "Installing Nexus CLI..."
          npm install --production
          npm link
          echo "‚úì Nexus CLI installed successfully!"
          echo "Run 'nexus --help' to get started"
          INSTALL_EOF
          chmod +x dist-package/install.sh

          # Create archive
          tar -czf nexus-cli-${{ github.ref_name }}.tar.gz dist-package/

          # Create checksums
          sha256sum nexus-cli-${{ github.ref_name }}.tar.gz > nexus-cli-${{ github.ref_name }}.tar.gz.sha256

      - name: Verify NPM Authentication
        run: |
          echo "Checking npm authentication..."
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "ERROR: NODE_AUTH_TOKEN is not set. Please configure NPM_TOKEN secret."
            exit 1
          fi
          npm whoami
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @adverant-nexus/types to NPM
        working-directory: packages/types
        run: |
          echo "Publishing @adverant-nexus/types..."
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @adverant-nexus/sdk to NPM
        working-directory: packages/sdk
        run: |
          echo "Publishing @adverant-nexus/sdk..."
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @adverant-nexus/cli to NPM
        working-directory: packages/cli
        run: |
          echo "Publishing @adverant-nexus/cli..."
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Nexus CLI ${{ github.ref_name }}
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## Nexus CLI ${{ github.ref_name }}

            ### üì¶ Quick Installation

            **Download & Install (Recommended)**
            ```bash
            # Download release archive
            curl -L https://github.com/adverant/Adverant-Nexus-CLI/releases/download/${{ github.ref_name }}/nexus-cli-${{ github.ref_name }}.tar.gz -o nexus-cli.tar.gz

            # Extract
            tar -xzf nexus-cli.tar.gz
            cd dist-package

            # Install (requires Node.js 20+)
            ./install.sh

            # Verify installation
            nexus --version
            ```

            **From NPM**
            ```bash
            npm install -g @adverant-nexus/cli
            ```

            **From Source**
            ```bash
            git clone https://github.com/adverant/Adverant-Nexus-CLI.git
            cd Adverant-Nexus-CLI
            npm install && npm run build
            cd packages/cli && npm link
            ```

            ### ‚ú® Features

            - ‚úÖ 60+ commands for Nexus service management
            - ‚úÖ Interactive REPL mode with tab completion
            - ‚úÖ Auto-discovery of services and MCP tools
            - ‚úÖ Session management and checkpointing
            - ‚úÖ Full TypeScript support (zero errors)
            - ‚úÖ Beautiful ASCII art banners
            - ‚úÖ Streaming output for real-time updates

            ### üöÄ Quick Start

            ```bash
            # View help
            nexus --help

            # List available services
            nexus services list

            # Check service health
            nexus services health --all

            # Start interactive shell
            nexus repl

            # View authentication options
            nexus auth --help
            ```

            ### üìù Changelog

            See full changes below (auto-generated).
          files: |
            nexus-cli-${{ github.ref_name }}.tar.gz
            nexus-cli-${{ github.ref_name }}.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
